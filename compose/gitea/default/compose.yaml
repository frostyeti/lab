services:
  gitea:
    image: gitea/gitea:${TAG:-latest}
    container_name: gitea
    restart: unless-stopped
    ports:
      - "${GITEA_HTTP_PORT:-3000}:3000"
      - "${GITEA_SSH_PORT:-2222}:22"
    environment:
      USER_UID: ${PUID:-1000}
      USER_GID: ${PGID:-1000}
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: ${GITEA_DB_HOST:-postgres}:5432
      GITEA__database__NAME: ${GITEA_DB_NAME:-gitea}
      GITEA__database__USER: ${GITEA_DB_USER:-gitea}
      GITEA__database__PASSWD: ${GITEA_DB_PASSWORD:-gitea}
      GITEA__server__DOMAIN: ${GITEA_HOST:-git.local}
      GITEA__server__SSH_DOMAIN: ${GITEA_HOST:-git.local}
      GITEA__server__ROOT_URL: "http://${GITEA_HOST:-git.local}/"
      GITEA__server__SSH_PORT: ${GITEA_SSH_PORT:-2222}
      GITEA__service__DISABLE_REGISTRATION: "${GITEA_DISABLE_REGISTRATION:-false}"
      GITEA__log__LEVEL: Warn
    volumes:
      - ${MNT_DIR}/data/gitea:/data
      - ${MNT_DIR}/etc/gitea:/etc/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/-/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      traefik.enable: "${TRAEFIK_ENABLE:-false}"
      traefik.http.routers.gitea.rule: "Host(`${GITEA_HOST:-git.local}`)"
      traefik.http.routers.gitea.entrypoints: "websecure"
      traefik.http.routers.gitea.tls: "true"
      traefik.http.routers.gitea.tls.certresolver: "letsencrypt"
      traefik.http.services.gitea.loadbalancer.server.port: "3000"
      traefik.http.services.gitea.loadbalancer.healthcheck.path: "/-/health"
      caddy: "${CADDY_ENABLE:-false}"
      caddy.reverse_proxy: ""
    networks:
      - vnet-frontend
      - vnet-backend

networks:
  vnet-frontend:
    external: true
  vnet-backend:
    external: true
