services:
  # ── PostgreSQL ──────────────────────────────────────────────────────────
  posthog-db:
    image: postgres:${DB_TAG:-15-alpine}
    container_name: posthog-db
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTHOG_DB_NAME:-posthog}
      POSTGRES_USER:     ${POSTHOG_DB_USER:-posthog}
      POSTGRES_PASSWORD: ${POSTHOG_DB_PASSWORD:-posthog}
    volumes:
      - ${MNT_DIR}/data/posthog-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTHOG_DB_USER:-posthog} -d ${POSTHOG_DB_NAME:-posthog}"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - vnet-backend

  # ── Redis ───────────────────────────────────────────────────────────────
  posthog-redis:
    image: redis:${REDIS_TAG:-7-alpine}
    container_name: posthog-redis
    restart: unless-stopped
    volumes:
      - ${MNT_DIR}/data/posthog-redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - vnet-backend

  # ── ClickHouse ──────────────────────────────────────────────────────────
  posthog-clickhouse:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_TAG:-23.12-alpine}
    container_name: posthog-clickhouse
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - ${MNT_DIR}/data/posthog-clickhouse:/var/lib/clickhouse
      - ${MNT_DIR}/log/posthog-clickhouse:/var/log/clickhouse-server
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - vnet-backend

  # ── Zookeeper (required by ClickHouse cluster mode) ─────────────────────
  posthog-zookeeper:
    image: zookeeper:${ZOOKEEPER_TAG:-3.9}
    container_name: posthog-zookeeper
    restart: unless-stopped
    volumes:
      - ${MNT_DIR}/data/posthog-zookeeper:/data
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - vnet-backend

  # ── Kafka ───────────────────────────────────────────────────────────────
  posthog-kafka:
    image: bitnami/kafka:${KAFKA_TAG:-3.6}
    container_name: posthog-kafka
    restart: unless-stopped
    environment:
      KAFKA_CFG_ZOOKEEPER_CONNECT:              posthog-zookeeper:2181
      KAFKA_CFG_LISTENERS:                       PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS:            PLAINTEXT://posthog-kafka:9092
      ALLOW_PLAINTEXT_LISTENER:                  "yes"
    volumes:
      - ${MNT_DIR}/data/posthog-kafka:/bitnami/kafka
    depends_on:
      posthog-zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - vnet-backend

  # ── PostHog web (Django + Gunicorn) ─────────────────────────────────────
  posthog-web:
    image: posthog/posthog:${TAG:-latest}
    container_name: posthog-web
    restart: unless-stopped
    ports:
      - "${POSTHOG_PORT:-8000}:8000"
    command: ./bin/docker-server
    environment:
      DATABASE_URL:     "postgres://${POSTHOG_DB_USER:-posthog}:${POSTHOG_DB_PASSWORD:-posthog}@posthog-db:5432/${POSTHOG_DB_NAME:-posthog}"
      REDIS_URL:        "redis://posthog-redis:6379/"
      CLICKHOUSE_HOST:  posthog-clickhouse
      KAFKA_HOSTS:      posthog-kafka:9092
      SECRET_KEY:       "${POSTHOG_SECRET_KEY:-changeme-replace-with-50-char-secret-key}"
      SITE_URL:         "${POSTHOG_SITE_URL:-http://posthog.local}"
      DISABLE_SECURE_SSL_REDIRECT: "true"
      IS_BEHIND_PROXY:  "true"
      TRUST_ALL_PROXIES: "true"
      POSTHOG_SKIP_ASYNC_MIGRATIONS_SETUP: "0"
    volumes:
      - ${MNT_DIR}/data/posthog:/var/lib/posthog
    depends_on:
      posthog-db:
        condition: service_healthy
      posthog-redis:
        condition: service_healthy
      posthog-clickhouse:
        condition: service_healthy
      posthog-kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/_health/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      traefik.enable: "${TRAEFIK_ENABLE:-false}"
      traefik.http.routers.posthog.rule: "Host(`${POSTHOG_HOST:-posthog.local}`)"
      traefik.http.routers.posthog.entrypoints: "websecure"
      traefik.http.routers.posthog.tls: "true"
      traefik.http.routers.posthog.tls.certresolver: "letsencrypt"
      traefik.http.services.posthog.loadbalancer.server.port: "8000"
      traefik.http.services.posthog.loadbalancer.healthcheck.path: "/_health/"
      traefik.http.services.posthog.loadbalancer.healthcheck.interval: "10s"
      caddy: "${CADDY_ENABLE:-false}"
      caddy.reverse_proxy: ""
    networks:
      - vnet-frontend
      - vnet-backend

  # ── PostHog async worker (Celery) ────────────────────────────────────────
  posthog-worker:
    image: posthog/posthog:${TAG:-latest}
    container_name: posthog-worker
    restart: unless-stopped
    command: ./bin/docker-worker-celery --without-gossip --without-mingle --without-heartbeat
    environment:
      DATABASE_URL:    "postgres://${POSTHOG_DB_USER:-posthog}:${POSTHOG_DB_PASSWORD:-posthog}@posthog-db:5432/${POSTHOG_DB_NAME:-posthog}"
      REDIS_URL:       "redis://posthog-redis:6379/"
      CLICKHOUSE_HOST: posthog-clickhouse
      KAFKA_HOSTS:     posthog-kafka:9092
      SECRET_KEY:      "${POSTHOG_SECRET_KEY:-changeme-replace-with-50-char-secret-key}"
    depends_on:
      posthog-web:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A posthog inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - vnet-backend

  # ── PostHog plugin server (Node.js) ──────────────────────────────────────
  posthog-plugins:
    image: posthog/posthog:${TAG:-latest}
    container_name: posthog-plugins
    restart: unless-stopped
    command: ./bin/plugin-server --no-restart-loop
    environment:
      DATABASE_URL:    "postgres://${POSTHOG_DB_USER:-posthog}:${POSTHOG_DB_PASSWORD:-posthog}@posthog-db:5432/${POSTHOG_DB_NAME:-posthog}"
      REDIS_URL:       "redis://posthog-redis:6379/"
      CLICKHOUSE_HOST: posthog-clickhouse
      KAFKA_HOSTS:     posthog-kafka:9092
      SECRET_KEY:      "${POSTHOG_SECRET_KEY:-changeme-replace-with-50-char-secret-key}"
    depends_on:
      posthog-web:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:6738/_health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - vnet-backend

networks:
  vnet-frontend:
    external: true
  vnet-backend:
    external: true
